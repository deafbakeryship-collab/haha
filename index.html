<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>ğŸ“± æ•¸æ“šæ¡é›†å™¨ - Google Drive ä¸Šå‚³ç‰ˆ (å–®æª”æ•´åˆ)</title>

Â  Â  Â  Â  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.4/dist/jsQR.min.js"></script>

Â  Â  Â  Â  <style>
        /* åŸºç¤æ¨£å¼ï¼Œé©åˆæ‰‹æ©Ÿè§¸æ§ */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 15px; 
            background-color: #2c3855; 
            color: #e6e6e6; 
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
        }
        h2 { 
            border-bottom: 2px solid #4a5d85; 
            padding-bottom: 5px; 
            color: #ffc107; 
        }

        /* å½±åƒå€å¡Š */
        #video-stream { 
            width: 100%; 
            border: 3px solid #007bff; 
            border-radius: 8px; 
            display: block; 
            margin-bottom: 15px;
            transition: opacity 0.1s; /* æ·»åŠ éæ¸¡æ•ˆæœ */
        }
        /* ç•«å¸ƒç”¨æ–¼èƒŒæ™¯è™•ç†ï¼Œæ•…éš±è— */
        #scan-canvas, #photo-canvas { 
            display: none; 
        } 

        /* æŒ‰éˆ•é¢¨æ ¼ */
        button { 
            padding: 12px; 
            margin-top: 10px; 
            width: 100%; 
            border: none; 
            border-radius: 5px; 
            font-weight: bold; 
            transition: background-color 0.3s;
            cursor: pointer;
        }
        #start-btn { 
            background-color: #17a2b8; 
            color: white; 
        }
        #capture-btn { 
            background-color: #28a745; 
            color: white; 
        }
        #output-btn { 
            background-color: #007bff; 
            color: white; 
        } 
        button:disabled { 
            background-color: #495057 !important; 
            color: #a9b5c7 !important; 
            cursor: not-allowed; 
        }

        /* è³‡è¨Šé¡¯ç¤º */
        #status-message { 
            padding: 10px; 
            background-color: #3d4a6a; 
            border-radius: 4px; 
            margin-bottom: 15px; 
            font-size: 0.9em; 
        }
        #order-display { 
            padding: 10px; 
            background-color: #556891; 
            border-radius: 4px; 
            margin-bottom: 15px; 
            min-height: 40px; 
        }
        #photo-preview { 
            margin-top: 15px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            border: 1px dashed #a9b5c7; 
            padding: 10px; 
            border-radius: 6px; 
            min-height: 60px;
        }
        #photo-preview img { 
            width: 60px; 
            height: 45px; 
            object-fit: cover; 
            border: 2px solid #ffc107; 
            border-radius: 4px; 
        }

        /* è¼¸å‡ºçµæœå€ */
        #output-area { 
            margin-top: 20px; 
            padding: 15px; 
            background-color: #3d4a6a; 
            border-radius: 8px; 
            display: none; 
        }
        #json-output { 
            width: 100%; 
            height: 150px; 
            border: 1px solid #556891; 
            background-color: #2c3855; 
            color: #e6e6e6; 
            padding: 10px; 
            box-sizing: border-box; 
            resize: none;
        }
        #copy-btn { 
            margin-top: 10px; 
            background-color: #dc3545; 
            color: white; 
        }
        #upload-status-message { 
            margin-top: 15px; 
            padding: 8px; 
            border: 1px solid #ffc107; 
            border-radius: 4px; 
            font-weight: bold; 
            background-color: #556891;
        }
	</style>
	</head>
<body>
Â  Â  <div class="container">
Â  Â  Â  Â  <h2>ğŸ“± æ‰‹æ©Ÿæ¡é›†ç«¯ (Google Drive é€£ç·š)</h2>
Â  Â  Â  Â  <p id="status-message">è«‹é»æ“Š **[å•Ÿå‹•ç›¸æ©Ÿ]**ï¼Œè®“æ‰‹æ©Ÿé¡é ­æº–å‚™æƒæã€‚</p>
Â  Â  Â  Â  
Â  Â  Â  Â  <button id="start-btn" onclick="startProcess()">â–¶ å•Ÿå‹•ç›¸æ©Ÿ</button>

Â  Â  Â  Â  <h3>1. è¨‚å–®è³‡è¨Š (QR Code æƒæ)</h3>
Â  Â  Â  Â  <div id="order-display">ç­‰å¾…æƒæ QR Code...</div>
Â  Â  Â  Â  
Â  Â  Â  Â  <h3>2. å½±åƒè­‰æ“šæ¡é›†</h3>
Â  Â  Â  Â  <video id="video-stream" autoplay playsinline></video>
Â  Â  Â  Â  <canvas id="scan-canvas"></canvas>
Â  Â  Â  Â  <canvas id="photo-canvas"></canvas>

Â  Â  Â  Â  <button id="capture-btn" disabled onclick="capturePhoto()">ğŸ“¸ æ‹æ”ç…§ç‰‡ (0)</button>
Â  Â  Â  Â  
Â  Â  Â  Â  <h4>å·²æ‹æ”é è¦½:</h4>
Â  Â  Â  Â  <div id="photo-preview"></div>
Â  Â  Â  Â  
Â  Â  Â  Â  <button id="output-btn" disabled onclick="outputData()">ğŸ’¾ ä¸Šå‚³æ•¸æ“šåŒ…è‡³ Google Drive</button>

Â  Â  Â  Â  <div id="output-area">
Â  Â  Â  Â  Â  Â  <h4>ä¸Šå‚³ç‹€æ…‹èˆ‡æ•¸æ“šå‚™ä»½ï¼š</h4>
            <p id="upload-status-message">é»æ“Šä¸Šå‚³æŒ‰éˆ•å¾Œå°‡å˜—è©¦é€£ç·š Apps Script...</p>
Â  Â  Â  Â  Â  Â  <textarea id="json-output" readonly></textarea>
Â  Â  Â  Â  Â  Â  <button id="copy-btn" onclick="copyToClipboard()">ğŸ“‹ ä¸€éµè¤‡è£½ JSON (æ‰‹å‹•å‚™ç”¨)</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

	Â  Â  <script>
        // --- è®Šæ•¸å®šç¾© ---
        const video = document.getElementById('video-stream');
        const scanCanvas = document.getElementById('scan-canvas');
        const photoCanvas = document.getElementById('photo-canvas');
        const startBtn = document.getElementById('start-btn');
        const captureBtn = document.getElementById('capture-btn');
        const outputBtn = document.getElementById('output-btn');
        const orderDisplay = document.getElementById('order-display');
        const statusMessage = document.getElementById('status-message');
        const photoPreview = document.getElementById('photo-preview');
        const jsonOutput = document.getElementById('json-output');
        const outputArea = document.getElementById('output-area');
        const uploadStatusMessage = document.getElementById('upload-status-message'); 

        let stream = null;
        let scanning = false;
        let scannedData = null; // å„²å­˜ç•¶å‰æƒæåˆ°çš„ QR Code å…§å®¹
        let photoEvidence = []; // å„²å­˜ Base64 å½±åƒé™£åˆ—

        // ğŸ¯ æ‚¨çš„ Apps Script Web App URL (å·²é…ç½®)
        const UPLOAD_URL = 'https://script.google.com/macros/s/AKfycbwt2t_dvs6vzzHzPEcMu-kBklfKnVRJBL6ulPaS-hpuxdK01j7N-BJ0_VU-ay2oXKbuzw/exec'; 

        // --- A. å•Ÿå‹•/åœæ­¢ç›¸æ©Ÿ ---
        function startProcess() {
            if (stream) { 
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                scanning = false;
                startBtn.textContent = 'â–¶ å•Ÿå‹•ç›¸æ©Ÿ';
                captureBtn.disabled = true;
                outputArea.style.display = 'none';
                statusMessage.textContent = 'ç›¸æ©Ÿå·²åœæ­¢ã€‚';
                return;
            }

            statusMessage.textContent = 'è¼‰å…¥ä¸­... è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚';
            
            // ä½¿ç”¨å¾Œé¡é ­ ("environment")
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" }, 
                audio: false 
            })
            .then(function(s) {
                stream = s;
                video.srcObject = stream;
                video.onloadedmetadata = function() {
                    video.play();
                    scanning = true;
                    startBtn.textContent = 'â—¼ åœæ­¢ç›¸æ©Ÿ';
                    statusMessage.textContent = 'âœ… ç›¸æ©Ÿå·²å•Ÿå‹•ã€‚è«‹å°‡ QR Code ç½®æ–¼é¡é ­å‰ã€‚';
                    requestAnimationFrame(tick); // é–‹å§‹æƒæå¾ªç’°
                };
            })
            .catch(function(err) {
                statusMessage.innerHTML = `<span style="color:#dc3545;">âŒ ç„¡æ³•å•Ÿå‹•é¡é ­: ${err.name} - è«‹æª¢æŸ¥æ¬Šé™ã€‚</span>`;
            });
        }

        // --- B. é€£çºŒæƒæ QR Code ---
        function tick() {
            if (!scanning || video.readyState !== 4) { // readyState === 4 è¡¨ç¤ºå½±ç‰‡å·²è¼‰å…¥å®Œç•¢
                requestAnimationFrame(tick);
                return;
            }

            scanCanvas.width = video.videoWidth;
            scanCanvas.height = video.videoHeight;
            const ctx = scanCanvas.getContext('2d');
            ctx.drawImage(video, 0, 0, scanCanvas.width, scanCanvas.height);
            
            const imageData = ctx.getImageData(0, 0, scanCanvas.width, scanCanvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                if (code.data !== scannedData) {
                    scannedData = code.data; 
                    handleScanSuccess(scannedData);
                }
            } else {
                if (scannedData === null) {
                    orderDisplay.innerHTML = 'è«‹å°‡ QR Code ç½®æ–¼é¡é ­å‰é€²è¡Œæƒæ...';
                }
            }

            requestAnimationFrame(tick);
        }

        function handleScanSuccess(data) {
            photoEvidence = []; // æƒææ–°å–®è™Ÿï¼Œæ¸…ç©ºèˆŠç…§ç‰‡
            photoPreview.innerHTML = '';
            
            const details = data.split('|');
            const orderId = details[0];

            orderDisplay.innerHTML = `<strong>è¨‚å–®ç·¨è™Ÿ:</strong> ${orderId}<br><strong>å®Œæ•´æ•¸æ“š:</strong> ${data}`;
            statusMessage.textContent = 'âœ… QR Code æƒææˆåŠŸï¼è«‹é–‹å§‹æ‹æ”è­‰æ“šç…§ç‰‡ã€‚';
            
            captureBtn.disabled = false;
            captureBtn.textContent = 'ğŸ“¸ æ‹æ”ç…§ç‰‡ (0)';
            outputBtn.disabled = true;
            outputArea.style.display = 'none';
            uploadStatusMessage.textContent = 'é»æ“Šä¸Šå‚³æŒ‰éˆ•å¾Œå°‡å˜—è©¦é€£ç·š Apps Script...';
        }

        // --- C. å½±åƒæ“·å–èˆ‡ Base64 è½‰æ› ---
        function capturePhoto() {
            if (scannedData === null || stream === null) { return; }
            
            photoCanvas.width = video.videoWidth;
            photoCanvas.height = video.videoHeight;
            const context = photoCanvas.getContext('2d');
            context.drawImage(video, 0, 0, photoCanvas.width, photoCanvas.height);
            
            // å°‡å½±åƒè½‰æ›ç‚º Base64ï¼Œä½¿ç”¨è¼ƒä½å“è³ª 0.5 (å¯ä¾éœ€æ±‚èª¿æ•´ 0.3~0.8)
            const dataURL = photoCanvas.toDataURL('image/jpeg', 0.5); 
            
            photoEvidence.push(dataURL);
            updatePhotoPreview(); 
            
            // è¦–è¦ºå›é¥‹
            video.style.opacity = '0.5';
            setTimeout(() => { video.style.opacity = '1'; }, 100);
            
            outputBtn.disabled = !(scannedData && photoEvidence.length > 0);
            outputArea.style.display = 'none'; // æ‹æ–°ç…§æ™‚éš±è—èˆŠè¼¸å‡º
        }

        function updatePhotoPreview() {
            photoPreview.innerHTML = photoEvidence.map((url, i) => 
                `<img src="${url}" alt="è­‰æ“šç…§ç‰‡ ${i+1}">`
            ).join('');
            captureBtn.textContent = `ğŸ“¸ æ‹æ”ç…§ç‰‡ (${photoEvidence.length})`;
        }

        // --- D. é›²ç«¯ä¸Šå‚³æ ¸å¿ƒå‡½å¼ (ç›®æ¨™ Google Apps Script) ---
        async function uploadData(jsonPayload) {
            
            uploadStatusMessage.innerHTML = 'ğŸ“¤ æ­£åœ¨å˜—è©¦ä¸Šå‚³æ•¸æ“šåˆ° Google Drive...';
            
            try {
                const response = await fetch(UPLOAD_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: jsonPayload
                });

                // æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
                if (response.status === 404) {
                    throw new Error("404 Not Found. Apps Script URL å¯èƒ½å·²å¤±æ•ˆæˆ–éŒ¯èª¤ã€‚");
                }
                if (response.status === 400) {
                    throw new Error("400 Bad Request. è«‹æ±‚æ ¼å¼éŒ¯èª¤ã€‚");
                }
                
                // å˜—è©¦è§£æ Apps Script å›å‚³çš„å…§å®¹
                const result = await response.json();

                if (result.success === true) {
                    uploadStatusMessage.innerHTML = `<span style="color:#28a745;">âœ… ä¸Šå‚³æˆåŠŸï¼ç…§ç‰‡å’Œæ•¸æ“šå·²å­˜å…¥ Google Driveã€‚</span>`;
                    
                    // ä¸Šå‚³æˆåŠŸå¾Œï¼Œé‡ç½®ç‹€æ…‹ï¼Œæº–å‚™ä¸‹ä¸€å€‹å–®è™Ÿ
                    scannedData = null;
                    photoEvidence = [];
                    updatePhotoPreview();
                    outputBtn.disabled = true;
                    orderDisplay.innerHTML = 'ç­‰å¾…æƒæ QR Code...';

                } else {
                    // è™•ç† Apps Script ç¨‹å¼ç¢¼å…§éƒ¨çš„éŒ¯èª¤
                    uploadStatusMessage.innerHTML = `<span style="color:#dc3545;">âŒ Apps Script è™•ç†å¤±æ•—ï¼š${result.error || 'æœªçŸ¥çš„ Apps Script éŒ¯èª¤'}</span>`;
                }

            } catch (error) {
                // è™•ç†ç¶²è·¯é€£ç·šéŒ¯èª¤ (ä¾‹å¦‚æ‰‹æ©Ÿæ–·ç¶²æˆ– URL éŒ¯èª¤)
                uploadStatusMessage.innerHTML = `<span style="color:#dc3545;">âŒ ç¶²è·¯æˆ–é€£ç·šéŒ¯èª¤ï¼šè«‹æª¢æŸ¥ç¶²è·¯æˆ– URLã€‚ (${error.message})</span>`;
                console.error('ä¸Šå‚³éŒ¯èª¤:', error);
            }
        }

        // --- E. æ•¸æ“šçµ„è£èˆ‡è§¸ç™¼ä¸Šå‚³ ---
        function outputData() {
            if (scannedData === null || photoEvidence.length === 0) {
                alert('è«‹å…ˆæƒæ QR Code ä¸¦æ‹æ”ç…§ç‰‡ã€‚');
                return;
            }

            const record = {
                id: Date.now(),
                orderId: scannedData.split('|')[0],
                fullDetails: scannedData,
                date: new Date().toLocaleString('zh-TW'),
                photos: photoEvidence // Base64 æ•¸æ“š
            };

            const outputArray = [record];
            const jsonStringForUpload = JSON.stringify(outputArray); 
            const jsonStringForDisplay = JSON.stringify(outputArray, null, 2); 

            // 1. é¡¯ç¤ºæ•¸æ“š (ä¾›æ‰‹å‹•å‚™ä»½)
            jsonOutput.value = jsonStringForDisplay;
            outputArea.style.display = 'block';

            // 2. åŸ·è¡Œé›²ç«¯ä¸Šå‚³
            uploadData(jsonStringForUpload);
        }

        // --- F. è¤‡è£½åˆ°å‰ªè²¼ç°¿ (æ‰‹å‹•å‚™ç”¨) ---
        function copyToClipboard() {
            jsonOutput.select(); 
            try {
                navigator.clipboard.writeText(jsonOutput.value)
                    .then(function() {
                        alert('âœ… JSON æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                    })
                    .catch(function(err) {
                        // å¦‚æœ navigator.clipboard å¤±æ•— (ä¾‹å¦‚åœ¨æŸäº›ä¸å®‰å…¨çš„ç’°å¢ƒ)ï¼Œä½¿ç”¨èˆŠæ–¹æ³•
                        document.execCommand('copy');
                        alert('âœ… JSON æ•¸æ“šå·²è¤‡è£½ï¼(è«‹æ‰‹å‹•æª¢æŸ¥å‰ªè²¼ç°¿)');
                    });
            } catch (err) {
                document.execCommand('copy');
                alert('âœ… JSON æ•¸æ“šå·²è¤‡è£½ï¼(è«‹æ‰‹å‹•æª¢æŸ¥å‰ªè²¼ç°¿)');
            }
        }
	</script>
	</body>
</html>